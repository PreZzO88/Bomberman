<!doctype html>
<HTML>
	<HEAD>
		<TITLE>:: Bomberman</TITLE>
		<script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
	</HEAD>
	<BODY style="background-color: #000000;">
		<div style="margin: 0px auto; text-align: center;">
			<canvas id="canvas" width="800" height="600" style="border-radius: 5px;"></canvas>
			<img id="bmcache" style="display: none;" src="imgs/bmcache.png" />
		</div>
		<script>
			//$(document).ready(function() {
				
				// Bomberman coded by David Preseault.
				// Note: Sprites and gameplay based on Jippii.fr Bomberman Game.
				
				var ctx = $("#canvas")[0].getContext("2d");
				var fpsctr = 0;
				var ts = new Date().getTime();
				var gameInfo = {
					bgcolor: "#4D7195",
					boardcolor: "#0075B9",
					board: [],
					boardx: 20,
					boardy: 20,
					boardw: 571,
					boardh: 451,
					me: "red",
					bmcache: $("#bmcache")[0],
					alternateAnimationSpeed: 200,
					players: { 
						red: { cr: 1, cc: 2, x: 0, y: 0, color: "red", dir: "u", altDir: 0, isStopping: 0, isStopped: 1, speed: "fastest" }
					},
					entityBitmap: {},
					speed: { normal: 0.5, fast: 0.75, fastest: 1 }
				};

				prepare();

				var timer = setInterval(
					function() {
						ctx.fillStyle = gameInfo.bgcolor;
						ctx.fillRect(10,1,40,11);
						ctx.font = "10pt verdana";
						ctx.fillStyle = "#FFFFFF";
						ctx.fillText(fpsctr + " FPS", 10, 10);
						fpsctr = 0;
					}, 1000);
				
				
				function mainRender() {
					fpsctr++;
					// players
					// items
					// active bombs
					// active explosions
					
					// Clear board and redraw everything except empty spaces.
					redrawBoard();
					
					var x, y, w, h, dir, currentRow, currentCol, isStopped, isStopping, collision, speed;
					
					for (color in gameInfo.players) {
						var player = gameInfo.players[color];
						x = player.x;
						y = player.y;
						w = player.w;
						h = player.h;
						dir = player.dir;
						currentRow = player.cr;
						currentCol = player.cc;
						isStopped = player.isStopped;
						isStopping = player.isStopping;
						speed = gameInfo.speed[player.speed];
						tlp = player.tlp;
						trp = player.trp;
						rtp = player.rtp;
						rbp = player.rbp;
						blp = player.blp;
						brp = player.brp;
						ltp = player.ltp;
						lbp = player.lbp;
						
						if (!isStopped) {
							switch (dir) {
								case "u":
									// UP
									collision = (isCollision(tlp) || isCollision(trp));
									if (collision) {
										drawPlayer(color, x, y, dir, 0);
										player.isStopping = 0;
										player.isStopped = 1;
									} else {
										movePlayer(color, x, y, speed, dir);
									}
									break;
								case "r":
									// RIGHT
									collision = (isCollision(rtp) || isCollision(rbp));
									if (collision) {
										drawPlayer(color, x, y, dir, 0);
										player.isStopping = 0;
										player.isStopped = 1;
									} else {
										movePlayer(color, x, y, speed, dir);
									}
									break;
								case "d":
									// DOWN
									collision = (isCollision(blp) || isCollision(brp));
									if (collision) {
										drawPlayer(color, x, y, dir, 0);
										player.isStopping = 0;
										player.isStopped = 1;
									} else {
										movePlayer(color, x, y, speed, dir);
									}
									break;
								case "l":
									// LEFT
									collision = (isCollision(ltp) || isCollision(lbp));
									if (collision) {
										drawPlayer(color, x, y, dir, 0);
										player.isStopping = 0;
										player.isStopped = 1;
									} else {
										movePlayer(color, x, y, speed, dir);
									}
									break;
							}
						} else {
							//console.log(color + " " + x + " " + y + " " + dir + " " + 0);
							drawPlayer(color, x, y, dir, 0);
						}
					}
					window.requestAnimationFrame(mainRender);
				}
				function isCollision(pair) {
					var row = Math.floor((pair.y - 20) / 30) + 1;
					var col = Math.floor((pair.x - 20) / 30) + 1;
					console.log(row + " " + col);
					console.log("collision: " + (gameInfo.board[row][col] != "e"));
					return (gameInfo.board[row][col] != "e");
				}
				function movePlayer(color, x, y, speed, dir) {
					var elapsed = new Date().getTime() - ts;
					var altDir = gameInfo.players[color].altDir;
					switch (dir) {
						case "u": y-=speed; break;
						case "d": y+=speed; break;
						case "l": x-=speed; break;
						case "r": x+=speed; break;
					}
					if (elapsed >= gameInfo.alternateAnimationSpeed) {
						ts = new Date().getTime();
						altDir++;
						if (altDir >= 3) { altDir = 1; }
					}
					if (gameInfo.players[color].isStopping) {
						gameInfo.players[color].altDir = 0;
						gameInfo.players[color].isStopping = 0;
						gameInfo.players[color].isStopped = 1;
					}
					gameInfo.players[color].altDir = altDir;
					drawPlayer(color, x, y, dir, altDir);
				}
				
				
				
				function drawItem(item, x, y) {
					ctx.drawImage(bmcache, gameInfo.entityBitmap[item].x, gameInfo.entityBitmap[item].y, gameInfo.entityBitmap[item].w, gameInfo.entityBitmap[item].h, x, y, gameInfo.entityBitmap[item].w, gameInfo.entityBitmap[item].h);
				}
				function drawPlayer(color, x, y, direction, alt) {
					var w = gameInfo.entityBitmap[color][direction + alt].w;
					var h = gameInfo.entityBitmap[color][direction + alt].h;
					var speed = gameInfo.speed[gameInfo.players[color].speed];
					gameInfo.players[color].x = x;
					gameInfo.players[color].y = y;
					gameInfo.players[color].w = w;
					gameInfo.players[color].h = h;
					
					// Top left pair
					gameInfo.players[color].tlp = { x: x, y: y-speed }
					
					// Top right pair
					gameInfo.players[color].trp = { x: x+w-1 , y: y-speed  }
					
					// Right top pair
					gameInfo.players[color].rtp = { x: x+w-1+speed, y: y }
					
					// Right bottom pair
					gameInfo.players[color].rbp = { x: x+w-1+speed, y: y+h-1 }
					
					// Bottom right pair
					gameInfo.players[color].brp = { x: x+w-1, y: y+h-1+speed }
					
					// Bottom left pair
					gameInfo.players[color].blp = { x: x, y: y+h-1+speed }
					
					// Left bottom pair
					gameInfo.players[color].lbp = { x: x-speed, y: y+h-1 }
					
					// Left top pair
					gameInfo.players[color].ltp = { x: x-speed, y: y }

					ctx.drawImage(bmcache, gameInfo.entityBitmap[color][direction + alt].x, gameInfo.entityBitmap[color][direction + alt].y, w, h, x, y, w, h);
				}
				
				function loadBoardTiles() {
					gameInfo.board[0] = "ooooooooooooooooooooo";
					gameInfo.board[1] = "oeebbbbbbeeebbbbbbeeo";
					gameInfo.board[2] = "oewbwbwbwbwbwbwbwbweo";
					gameInfo.board[3] = "obbbbbbbbbbbbbbbbbbbo";
					gameInfo.board[4] = "obwbwbwbwbwbwbwbwbwbo";
					gameInfo.board[5] = "obbbbbbbbbbbbbbbbbbbo";
					gameInfo.board[6] = "obwbwbwbwbwbwbwbwbwbo";
					gameInfo.board[7] = "oebbbbbbbbbbbbbbbbbeo";
					gameInfo.board[8] = "oewbwbwbwbwbwbwbwbweo";
					gameInfo.board[9] = "oebbbbbbbbbbbbbbbbbeo";
					gameInfo.board[10] = "obwbwbwbwbwbwbwbwbwbo";
					gameInfo.board[11] = "obbbbbbbbbbbbbbbbbbbo";
					gameInfo.board[12] = "obwbwbwbwbwbwbwbwbwbo";
					gameInfo.board[13] = "obbbbbbbbbbbbbbbbbbbo";
					gameInfo.board[14] = "oewbwbwbwbwbwbwbwbweo";
					gameInfo.board[15] = "oeebbbbbbeeebbbbbbeeo";
					gameInfo.board[16] = "ooooooooooooooooooooo";
					gameInfo.board = gameInfo.board.map(function(cols) { return cols.split(""); });
				}
				function loadEntityBitmap() {
					gameInfo.entityBitmap["w"] = { x: 0, y: 30, w: 31, h: 31 };
					gameInfo.entityBitmap["b"] = { x: 0, y: 0, w: 31, h: 31 };
					gameInfo.entityBitmap["bomb"] = { x: 1, y: 145, w: 28, h: 30 };
					gameInfo.entityBitmap["armor"] = { x: 36, y: 203, w: 22, h: 27 };
					gameInfo.entityBitmap["speed"] = { x: 1, y: 62, w: 30, h: 22 };
					gameInfo.entityBitmap["exp"] = { x: 4, y: 85, w: 24, h: 26 };
					gameInfo.entityBitmap["abomb"] = { x: 0, y: 113, w: 30, h: 30 };
					
					var colors = [ "pink", "cyan", "red", "yellow", "blue", "lime", "gold", "green" ];
					var y = 0;
					for (color in colors) {
						gameInfo.entityBitmap[colors[color]] = {
							d0: { x: 33, y: y, w: 29, h: 23 }, d1: { x: 144, y: y, w: 29, h: 23 }, d2: { x: 255, y: y, w: 29, h: 23 },
							u0: { x: 87, y: y, w: 29, h: 23 }, u1: { x: 198, y: y, w: 29, h: 22 }, u2: { x: 309, y: y, w: 29, h: 22 },
							r0: { x: 120, y: y, w: 20, h: 23 }, r1: { x: 231, y: y, w: 20, h: 23 }, r2: { x: 342, y: y, w: 20, h: 23 },
							l0: { x: 65, y: y, w: 20, h: 23 }, l1: { x: 176, y: y, w: 20, h: 23}, l2: { x: 287, y: y, w: 20, h: 23 }
						};
						y+= 25;
					}
				}
				
				function redrawBoard() {
					// Board Fill
					ctx.fillStyle = gameInfo.boardcolor;
					ctx.fillRect(gameInfo.boardx,gameInfo.boardy,gameInfo.boardw,gameInfo.boardh);
					
					// Put all items on board except empty.
					// Starting at row 1 and col 1 and ending 1 short of each due to outside border being "outside" area.
					var x = gameInfo.boardx;
					var y = gameInfo.boardy;
					var item;
					for (var r = 1; r < gameInfo.board.length-1; r++ ) {
						for (var c = 1; c < gameInfo.board[r].length-1; c++) {
							item = gameInfo.board[r][c];
							if (item != "e") {
								drawItem(item, x, y);
							}
							x += 30;
						}
						x = gameInfo.boardx;
						y += 30;
					}
				}
				function prepare() {
					ctx.clearRect ( 0 , 0 , ctx.canvas.width, ctx.canvas.height );
					// Main Window
					ctx.fillStyle = gameInfo.bgcolor;
					ctx.fillRect(0,0,800,600);
					
					loadEntityBitmap();				
					loadBoardTiles();
					
					// Board
					redrawBoard();
					
					drawPlayer("red",21,233, "d", 0);
					for (var n = 0; n < 8; n++) {
						drawBox(610,20 + (n * 57), 170, 50);
					}
					// Launch renderer.
					mainRender();
					
				}
				
				function drawBox(x,y,w,h) {
					//1 239 4 4 left-top
					//4 239 4 4 right-top
					//1 260 4 4 left-bottom
					//4 260 4 4 right-bottom
					ctx.beginPath();
					var offset = 3;
					ctx.moveTo(x, y + offset);
					ctx.lineTo(x + offset, y);
					ctx.lineTo(w + x - offset, y);
					ctx.lineTo(w + x, y + offset);
					ctx.lineTo(w + x, y + h - offset);
					ctx.lineTo(w + x - offset, y + h);
					ctx.lineTo(x + offset, y + h);
					ctx.lineTo(x, y + h - offset);
					ctx.lineTo(x, y + offset);
					ctx.closePath();
					ctx.fillStyle = '#496B8D';
					ctx.fill();
					ctx.strokeStyle = "#000000";
					ctx.stroke();
					
				}
				
				
				// ***** LISTENERS - KEYS
				
				
				$(document).keyup(function(e) {
					console.log("stopped");
					var player = gameInfo.players[gameInfo.me];
					player.isStopping = 1;
				});
				$(document).keydown(function(e) {
					// Up - Right - Down - Left
					var player = gameInfo.players[gameInfo.me];
					if (e.keyCode == 38) {
						e.preventDefault();
						if (player.dir != "u" || player.isStopped) {
							player.isStopped = 0;
							player.dir = "u";
							player.altDir = 0;
						}
					} else if (e.keyCode == 39) {
						e.preventDefault();
						if (player.dir != "r" || player.isStopped) {
							player.isStopped = 0;
							player.dir = "r";
							player.altDir = 0;
						}
					} else if (e.keyCode == 40) {
						e.preventDefault();
						if (player.dir != "d" || player.isStopped) {
							player.isStopped = 0;
							player.dir = "d";
							player.altDir = 0;
						}
					} else if (e.keyCode == 37) {
						e.preventDefault();
						if (player.dir != "l" || player.isStopped) {
							player.isStopped = 0;
							player.dir = "l";
							player.altDir = 0;
						}
					} else if (e.keyCode == 32) {
						e.preventDefault();
						layBomb();
					}
					//38=up
					//39=right
					//40=down
					//37=left
				});
			//});			
		</script>
	</BODY>
</HTML>